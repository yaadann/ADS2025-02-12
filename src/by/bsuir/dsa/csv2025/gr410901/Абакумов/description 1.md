# Название

Сумма элементов в прямоугольной области

# Описание

Сумма элементов в прямоугольной области

## Описание

Данная задача посвящена эффективному вычислению суммы элементов в прямоугольных областях матрицы с использованием алгоритма **двумерных префиксных сумм**.

### Практическое применение

- **Обработка изображений**: подсчет суммы яркости пикселей в прямоугольных областях для фильтрации и анализа
- **Компьютерное зрение**: вычисление интегральных изображений (integral images) для быстрого детектирования объектов
- **Анализ данных**: подсчет сумм значений в таблицах данных для статистического анализа
- **Геоинформационные системы**: обработка растровых данных, подсчет значений в заданных регионах

### Формулировка задачи

Дана матрица размером `n × m` с целочисленными элементами. Необходимо ответить на `k` запросов, каждый из которых задает прямоугольную область матрицы. Для каждого запроса требуется найти сумму всех элементов в этой области.

### Входные данные

- Первая строка содержит два целых числа `n` и `m` (1 ≤ n, m ≤ 1000) — размеры матрицы
- Следующие `n` строк содержат по `m` целых чисел — элементы матрицы (от -10⁹ до 10⁹)
- Следующая строка содержит целое число `k` (1 ≤ k ≤ 10⁵) — количество запросов
- Каждая из следующих `k` строк содержит четыре целых числа `x1`, `y1`, `x2`, `y2` (1 ≤ x1 ≤ x2 ≤ n, 1 ≤ y1 ≤ y2 ≤ m) — координаты прямоугольной области, где (x1, y1) — левый верхний угол, (x2, y2) — правый нижний угол (индексация с 1, включительно)

### Выходные данные

Для каждого запроса выведите одно целое число — сумму всех элементов матрицы в указанной прямоугольной области.

### Пример

**Входные данные:**
```
3 4
1 2 3 4
5 6 7 8
9 10 11 12
3
1 1 2 3
2 2 3 4
1 1 3 4
```

**Выходные данные:**
```
24
45
78
```

**Пояснение:**
- Запрос 1: область от (1,1) до (2,3) содержит элементы: 1+2+3+5+6+7 = 24
- Запрос 2: область от (2,2) до (3,4) содержит элементы: 6+7+8+10+11+12 = 54
- Запрос 3: область от (1,1) до (3,4) содержит все элементы матрицы: 1+2+3+4+5+6+7+8+9+10+11+12 = 78

### Алгоритм решения

Задача решается с помощью **двумерных префиксных сумм**:

1. **Предобработка** (O(n×m)):
   - Строим массив `prefix[i][j]`, который содержит сумму всех элементов от (0,0) до (i-1, j-1)
   - Формула построения: `prefix[i][j] = matrix[i-1][j-1] + prefix[i-1][j] + prefix[i][j-1] - prefix[i-1][j-1]`

2. **Ответ на запрос** (O(1)):
   - Для прямоугольника от (x1, y1) до (x2, y2) используем формулу:
   - `sum = prefix[x2+1][y2+1] - prefix[x1][y2+1] - prefix[x2+1][y1] + prefix[x1][y1]`

### Требования к реализации

- Использовать алгоритм двумерных префиксных сумм
- Временная сложность: O(n×m + k) — предобработка за O(n×m), ответ на каждый запрос за O(1)
- Пространственная сложность: O(n×m) — для хранения матрицы и префиксных сумм
- Обработать случаи с большими числами (использовать тип `long`)

### Раздел алгоритмики

Данная задача относится к разделу **"Префиксные суммы и разностные массивы"** на algorithmica.org, который охватывает:
- Одномерные префиксные суммы
- Двумерные префиксные суммы
- Применение префиксных сумм для оптимизации запросов
- Интегральные изображения

# Краткая теория

---
title: Двумерные префиксные суммы
weight: 2
authors:
- Abakumov Gennadiy
created: 2025
---

**Определение.** _Двумерными префиксными суммами_ матрицы $A$ размером $n \times m$ называется матрица $P$ размером $(n+1) \times (m+1)$, определенная следующим образом:

$$
\begin{aligned}
& P[0][j] = 0 \quad \text{для всех } j \\
& P[i][0] = 0 \quad \text{для всех } i \\
& P[i][j] = \sum_{x=0}^{i-1} \sum_{y=0}^{j-1} A[x][y]
\end{aligned}
$$

Обратите внимание, что в такой индексации:

* $P[i][j]$ равен сумме всех элементов матрицы $A$ в прямоугольнике от $(0, 0)$ до $(i-1, j-1)$ не включая границы,
* размер $P$ на единицу больше размера $A$ по каждому измерению,
* нулевая строка и нулевой столбец всегда равны нулю.

Формулу для $P[i][j]$ можно записать рекуррентно, используя принцип включений-исключений:

$$
P[i][j] = A[i-1][j-1] + P[i-1][j] + P[i][j-1] - P[i-1][j-1]
$$

Это дает метод подсчета двумерных префиксных сумм за $O(n \cdot m)$:

```java
long[][] prefix = new long[n + 1][m + 1];

for (int i = 0; i <= n; i++) {
    prefix[i][0] = 0;
}
for (int j = 0; j <= m; j++) {
    prefix[0][j] = 0;
}

for (int i = 1; i <= n; i++) {
    for (int j = 1; j <= m; j++) {
        prefix[i][j] = matrix[i-1][j-1] 
                     + prefix[i-1][j] 
                     + prefix[i][j-1] 
                     - prefix[i-1][j-1];
    }
}
```

